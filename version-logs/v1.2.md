# Version 1.2 - Changelog

## âœ¨ TÃ­nh nÄƒng má»›i

- **Auto-Export**: Checkbox "Tá»± Ä‘á»™ng export CSV sau khi scrape xong" - tá»± Ä‘á»™ng chia file náº¿u >200 items
- **Data Validation**: Validate data trÆ°á»›c khi export, cáº£nh bÃ¡o dataset lá»›n (>1000 items)
- **Storage Management**: Auto-cleanup data >24h, check quota trÆ°á»›c khi save

## ğŸ› Bug Fixes

### State khÃ´ng Reset sau khi Clear + Routing
- **Váº¥n Ä‘á»**: Sau khi xÃ³a káº¿t quáº£ vÃ  routing sang category khÃ¡c, pháº£i F5 má»›i scrape Ä‘Æ°á»£c "1 click", pháº£i click láº§n 2 má»›i quÃ©t detail
- **NguyÃªn nhÃ¢n**: Message listeners vÃ  storage state khÃ´ng Ä‘Æ°á»£c cleanup Ä‘Ãºng cÃ¡ch
- **Fix**: 
  - Clear storage state (`scrapeDetailsState`, `paginationState`) trÆ°á»›c khi báº¯t Ä‘áº§u scrape má»›i
  - Validate vÃ  cleanup state trong `handleScrapeListAndDetails`
  - Äáº£m báº£o requestId unique má»—i láº§n scrape

### Skip Logic khÃ´ng hoáº¡t Ä‘á»™ng Ä‘Ãºng
- **Váº¥n Ä‘á»**: Khi skip=100, limit=100 â†’ nÃªn scrape items 101-200 nhÆ°ng láº¡i scrape 1-100
- **NguyÃªn nhÃ¢n**: 
  - Products bá»‹ slice sá»›m trong pagination/scroll handlers (chá»‰ tráº£ vá» `maxProducts` items)
  - Skip logic apply sau khi Ä‘Ã£ slice â†’ khÃ´ng Ä‘á»§ items
- **Fix**:
  - KhÃ´ng slice products sá»›m trong pagination/scroll handlers
  - Tráº£ vá» táº¥t cáº£ products scraped, Ä‘á»ƒ caller xá»­ lÃ½ skip logic
  - Apply skip sau khi extract links: `.slice(skipProducts, skipProducts + maxDetails)`
  - Validate: Ä‘áº£m báº£o cÃ³ Ä‘á»§ items trÆ°á»›c khi apply skip
  - Scrape Ä‘á»§ sá»‘ lÆ°á»£ng: `totalToScrape = skipProducts + maxProducts`

### Browser Crash khi Export Large Datasets
- **Váº¥n Ä‘á»**: Crash khi export >200 items CSV
- **Fix**: Chia thÃ nh nhiá»u files (100 items/file), batch processing, truncation limits, depth limit (5)

### Files khÃ´ng Download Ä‘Æ°á»£c
- **Váº¥n Ä‘á»**: Logs hiá»ƒn thá»‹ nhÆ°ng files khÃ´ng xuáº¥t hiá»‡n
- **Fix**: TÄƒng delay revoke URL (3000ms), delay giá»¯a downloads (2500ms), double requestAnimationFrame

### Crash khi xá»­ lÃ½ Item thá»© 50
- **Váº¥n Ä‘á»**: Crash á»Ÿ item 50/100 trong chunk Ä‘áº§u tiÃªn
- **Fix**: Cáº£i thiá»‡n error handling, giá»›i háº¡n keys/object (1000), skip items lá»—i thay vÃ¬ crash

### Storage Overflow & Data Loss
- **Fix**: Check quota trÆ°á»›c khi save, auto-cleanup, save vÃ o storage TRÆ¯á»šC khi send message

## ğŸ”§ Cáº£i thiá»‡n Performance

- Memory: Chia files nhá», batch processing, truncation limits (string: 50k, row: 1M, array: 500)
- Export: Collect headers tá»« 5 items Ä‘áº§u, batch join rows, direct download cho files >2MB
- Code: Refactor tá»« 982 â†’ 739 dÃ²ng, loáº¡i bá» code trÃ¹ng láº·p

## ğŸ“‹ Workflow

**TrÆ°á»›c**: User scrape â†’ Save â†’ User manually export â†’ Download  
**BÃ¢y giá»**: User scrape â†’ Save â†’ Auto-export (náº¿u enabled) â†’ Auto-split â†’ Download

## âš ï¸ Cáº§n Monitor

- Memory issues vá»›i datasets >500 items (Ä‘Ã£ cÃ³ split files)
- Download failures vá»›i >10 files (Ä‘Ã£ cÃ³ delays)
- Circular references trong data (Ä‘Ã£ cÃ³ WeakSet detection)

## ğŸ“ Files Changed

- `handlers/export-handler.js` - Complete refactor
- `popup-main.js` - Auto-export logic
- `ui/popup-state.js` - Storage management
- `popup.html` - Auto-export checkbox
